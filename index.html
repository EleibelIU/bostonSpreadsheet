<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Airbnb Listings</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/hack-font/3.3.0/web/hack.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.21/lodash.min.js"></script>
    <style>
        :root {
            --background: #272822;
            --card-bg: #1E1F1C;
            --primary: #A6E22E;
            --secondary: #F8F8F2;
            --accent: #FD971F;
            --highlight: #66D9EF;
            --danger: #F92672;
            --success: #A6E22E;
            --warning: #FD971F;
            --muted: #75715E;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: Hack, 'Courier New', Courier, monospace;
        }

        body {
            background-color: var(--background);
            color: var(--secondary);
            line-height: 1.5;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 1rem;
        }

        .header {
            background-color: var(--card-bg);
            padding: 1.5rem;
            margin-bottom: 2rem;
            border-radius: 12px;
            border: 1px solid var(--muted);
        }

        .header h1 {
            color: var(--highlight);
            font-size: 1.8rem;
            margin-bottom: 0.5rem;
        }

        .content-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
        }

        .section-title {
            color: var(--highlight);
            font-size: 1.2rem;
            margin-bottom: 1rem;
            padding-left: 0.5rem;
            border-left: 3px solid var(--accent);
        }

        .map-section {
            position: sticky;
            top: 1rem;
        }

        .map-container {
            background-color: var(--card-bg);
            padding: 1rem;
            border-radius: 8px;
            border: 1px solid var(--muted);
            height: 500px;
            margin-bottom: 1rem;
        }

        #map {
            width: 100%;
            height: 100%;
            border-radius: 4px;
        }

        .leaflet-popup-content-wrapper {
            background-color: var(--card-bg);
            color: var(--secondary);
        }

        .leaflet-popup-tip {
            background-color: var(--card-bg);
        }

        .leaflet-tile {
            filter: brightness(0.6) invert(1) contrast(3) hue-rotate(200deg) saturate(0.3) brightness(0.7);
        }

        .listings-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1rem;
        }

        .listing-card {
            background: var(--card-bg);
            border-radius: 12px;
            overflow: hidden;
            transition: transform 0.2s, border-color 0.2s;
            border: 1px solid var(--muted);
        }

        .listing-card:hover {
            transform: translateY(-4px);
            border-color: var(--highlight);
        }

        .listing-content {
            padding: 1.25rem;
        }

        .listing-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--accent);
            margin-bottom: 0.5rem;
        }

        .listing-location {
            color: var(--muted);
            margin-bottom: 1rem;
        }

        .location-button {
            background: none;
            border: none;
            color: var(--highlight);
            cursor: pointer;
            padding: 0;
            font: inherit;
            text-decoration: underline;
        }

        .listing-details {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.75rem;
            margin-bottom: 1rem;
        }

        .listing-detail span {
            color: var(--secondary);
        }

        .listing-price {
            font-size: 1.2rem;
            color: var(--highlight);
            margin-bottom: 0.5rem;
        }

        .total-price {
            font-size: 0.9rem;
            color: var(--muted);
        }

        .listing-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 0.75rem;
            border-top: 1px solid var(--muted);
        }

        .badge {
            padding: 0.25rem 0.75rem;
            border-radius: 999px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .badge-success {
            background-color: var(--success);
            color: var(--card-bg);
        }

        .badge-warning {
            background-color: var(--warning);
            color: var(--card-bg);
        }

        .view-link {
            display: inline-block;
            padding: 0.5rem 1rem;
            background-color: var(--primary);
            color: var(--card-bg);
            text-decoration: none;
            border-radius: 8px;
            transition: background-color 0.2s;
        }

        .view-link:hover {
            background-color: var(--highlight);
        }

        .tooltip {
            position: relative;
            cursor: help;
        }

        .tooltip:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            padding: 0.5rem;
            background-color: var(--card-bg);
            color: var(--secondary);
            border-radius: 4px;
            font-size: 0.8rem;
            white-space: nowrap;
            z-index: 1000;
            border: 1px solid var(--muted);
        }

        @media (max-width: 1024px) {
            .content-grid {
                grid-template-columns: 1fr;
            }
            
            .map-section {
                position: static;
                margin-bottom: 2rem;
            }

            .map-container {
                height: 400px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>> DrakkenhomieFinder_v1.0</h1>
            <p>// Available properties near The Palladium</p>
        </header>

        <div class="content-grid">
            <div class="map-section">
                <h2 class="section-title">> Location.Map</h2>
                <div class="map-container">
                    <div id="map"></div>
                </div>
                <div class="legend" style="background: var(--card-bg); padding: 1rem; border-radius: 8px; border: 1px solid var(--muted);">
                    <h3 style="color: var(--accent); margin-bottom: 0.5rem;">Map Legend</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;">
                        <div>üé∏ Venue Location</div>
                        <div>üü¢ High Viability</div>
                        <div>üìç Property Location</div>
                        <div>üü° Lower Viability</div>
                    </div>
                </div>
            </div>

            <div class="listings-section">
                <h2 class="section-title">> Available.Properties</h2>
                <div class="listings-grid" id="listings-container">
                    <!-- Listings will be dynamically inserted here -->
                </div>
            </div>
        </div>
    </div>

    <script>
        let map;
        let markers = [];
        const VENUE_LOCATION = [42.2626, -71.8023]; // The Palladium, Worcester coordinates

        function initMap() {
            map = L.map('map').setView(VENUE_LOCATION, 11);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors'
            }).addTo(map);

            const venueIcon = L.divIcon({
                className: 'custom-div-icon',
                html: `<div style="background-color: #F92672; width: 15px; height: 15px; border-radius: 50%; border: 2px solid white;"></div>`,
                iconSize: [15, 15]
            });

            L.marker(VENUE_LOCATION, {
                icon: venueIcon,
                title: "The Palladium"
            })
            .bindPopup("<div style='color: #F8F8F2;'>The Palladium</div>")
            .addTo(map);
        }

        async function geocodeLocation(location) {
            if (!location) return null;
            
            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(location + ', MA, USA')}`);
                const data = await response.json();
                
                if (data && data.length > 0) {
                    return [parseFloat(data[0].lat), parseFloat(data[0].lon)];
                }
                return null;
            } catch (error) {
                console.error('Geocoding error:', error);
                return null;
            }
        }

        function createMarker(coordinates, name, location, viability) {
            const markerIcon = L.divIcon({
                className: 'custom-div-icon',
                html: `<div style="background-color: ${viability >= 4 ? '#A6E22E' : '#FD971F'}; 
                       width: 12px; height: 12px; border-radius: 50%; border: 2px solid white;"></div>`,
                iconSize: [12, 12]
            });

            const marker = L.marker(coordinates, {
                icon: markerIcon,
                title: name
            });

            marker.bindPopup(`<div style='color: #F8F8F2;'>
                <strong>${name}</strong><br>
                ${location}, MA
            </div>`);

            marker.addTo(map);
            markers.push({ marker, name });
        }

        function highlightMarker(name) {
            const markerInfo = markers.find(m => m.name === name);
            if (markerInfo) {
                map.setView(markerInfo.marker.getLatLng(), 13);
                markerInfo.marker.openPopup();
            }
        }

        function formatMoney(amount) {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD'
            }).format(amount);
        }

        function getViabilityBadge(viability) {
            const className = viability >= 4 ? 'badge-success' : 'badge-warning';
            return `<span class="badge ${className}" data-tooltip="Property Rating: ${viability} out of 5">${viability}/5</span>`;
        }

        function createListingCard(listing) {
            const locationDisplay = listing.Location ? 
                `<button class="location-button" onclick="highlightMarker('${listing["Name "]}')" style="color: var(--highlight);">
                    üìç ${listing.Location}
                </button>` : 
                'Location N/A';

            return `
                <article class="listing-card">
                    <div class="listing-content">
                        <h2 class="listing-title">${listing["Name "]}</h2>
                        
                        <div class="listing-location">
                            ${locationDisplay}
                        </div>

                        <div class="listing-details">
                            <div class="listing-detail">
                                <span class="tooltip" data-tooltip="Number of Bedrooms">üõèÔ∏è ${listing.Bedrooms} BR</span>
                            </div>
                            <div class="listing-detail">
                                <span class="tooltip" data-tooltip="Number of Bathrooms">üöø ${listing.Bathrooms} Bath</span>
                            </div>
                            <div class="listing-detail">
                                <span class="tooltip" data-tooltip="Distance from Airport">‚úàÔ∏è ${listing["Distance from Airport (minutes)"]}min</span>
                            </div>
                            <div class="listing-detail">
                                <span class="tooltip" data-tooltip="Distance from Palladium Venue">üé∏ ${listing["Distance (approx. Minutes) from Palladium show VENUE"]}min</span>
                            </div>
                        </div>

                        <div class="listing-price">
                            ${listing["Cost/Person (ENTIRE TRIP)"]} per person
                            <div class="total-price">
                                Total: ${formatMoney(listing["Total cost (With Taxes)"])}
                            </div>
                        </div>

                        <div class="listing-meta">
                            ${getViabilityBadge(listing.Viability)}
                            <span class="tooltip" data-tooltip="${listing.Refundable ? 'Booking is refundable' : 'Booking is non-refundable'}">
                                ${listing.Refundable ? '‚úì Refundable' : '√ó Non-refundable'}
                            </span>
                            <a href="${listing.Url}" target="_blank" class="view-link">View Details</a>
                        </div>
                    </div>
                </article>
            `;
        }

        document.addEventListener("DOMContentLoaded", async function () {
            try {
                initMap();
                const response = await fetch('Drakkenhomies_Boston_AirBNB.json');
                const data = await response.json();
                
                const container = document.getElementById('listings-container');
                const sortedData = _.sortBy(data, listing => -listing.Viability);
                
                container.innerHTML = sortedData
                    .map(listing => createListingCard(listing))
                    .join('');

                // Add markers for each location with a delay to prevent rate limiting
                for (const listing of sortedData) {
                    if (listing.Location) {
                        // Add delay between geocoding requests
                        await new Promise(resolve => setTimeout(resolve, 1000));
                        const coordinates = await geocodeLocation(listing.Location);
                        if (coordinates) {
                            createMarker(coordinates, listing["Name "], listing.Location, listing.Viability);
                        }
                    }
                }

                // Fit map bounds to show all markers
                const bounds = L.latLngBounds([VENUE_LOCATION]);
                markers.forEach(({ marker }) => {
                    bounds.extend(marker.getLatLng());
                });
                map.fitBounds(bounds);

            } catch (error) {
                console.error('Error loading listings:', error);
            }
        });